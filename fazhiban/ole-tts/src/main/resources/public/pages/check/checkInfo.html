<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
<link href="../../css/bootstrap-datetimepicker.min.css" rel="stylesheet">
<link href="../../css/select2.min.css" rel="stylesheet">
<link href="../../css/jquery-confirm/jquery-confirm.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" media="screen" href="../../easyui/easyui.css">
<link rel="stylesheet" type="text/css" media="screen" href="../../layui/css/layui.css">
<link rel="stylesheet" href="../../css/font-awesome/css1/font-awesome.css" media="all">
</head>
<body>
<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
	<form class="form-horizontal" onsubmit="return false" id="form">
		<fieldset>
			<div class="form-group">
			<label class="col-md-2 control-label">检查内部编号</label>
			<div class="col-md-4">
			    <input class="form-control" readonly="readonly" type="text" name="id" id="id">
			</div>
			<label class="col-md-2 control-label">检查编号</label>
			<div class="col-md-4">
			    <input class="form-control" readonly="readonly" type="text" name="checkNum" id="checkNum">
			</div>
		</div>
			<div class="form-group">
				<label class="col-md-2 control-label">检查标题</label>
				<div class="col-md-4">
					<input class="form-control"  readonly="readonly" placeholder="请输入检查标题" type="text" id="checkTitle" name="checkTitle"
						data-bv-notempty="true"
						data-bv-notempty-message="检查标题为空">
				</div>
				<label class="col-md-2 control-label">检查对象</label>
				<div class="col-md-4">
					<input class="form-control" readonly="readonly"  placeholder="请输入检查对象" type="text" id="checkObject" name="checkObject"
						data-bv-notempty="true"
						data-bv-notempty-message="检查对象为空">
				</div>
			</div>
			
			<div class="form-group">
				<label class="col-md-2 control-label">检查开始时间</label>
				<div class="col-md-4">
					<input placeholder="请输入检查开始时间" readonly="readonly"  class="form-control" type="text" name="startDate"
						id="startDate">
				</div>
				
				<label class="col-md-2 control-label">检查结束时间</label>
				<div class="col-md-4">
					<input placeholder="请输入检查结束时间" readonly="readonly"  class="form-control" type="text" name="endDate"
						id="endDate">
				</div>
			</div>
		
			<div class="form-group">
				<label class="col-md-2 control-label">检查部门</label>
				<div class="col-md-4">
					<input class="form-control" id="dept" readonly="readonly"  type="text" style="width:100%" name="deptid"/>
				</div>
				
				<label class="col-md-2 control-label">执法人员</label>
				<div class="col-md-4">
					<input class="form-control"  readonly="readonly" id="personId" name="personid"/>
				</div>
			</div>
			
			<div class="form-group">
				<label class="col-md-2 control-label">检查依据</label>
				<div class="col-md-4">
					<input class="form-control" readonly="readonly"  placeholder="请输入检查依据" id="checkBasis" type="text" name="checkBasis"
						data-bv-notempty="true"
						data-bv-notempty-message="检查标题为空">
				</div>
				<label class="col-md-2 control-label">检查方式</label>
				<div class="col-md-4">
				<select class="form-control not-null" id="checkWay"  readonly="readonly" iname="检查方式" name="checkWay"
						data-bv-notempty="true">
						<option value="2">专项检查</option>
				</select>
				</div>
			</div>
			
			<div class="form-group">
				<label class="col-md-2 control-label">检查内容</label>
				<div class="col-md-10">
					<textarea class="form-control" readonly="readonly"  rows="" cols="" id="checkContent" name="checkContent" placeholder="请输入检查内容"
						data-bv-notempty="true"
						data-bv-notempty-message="检查内容不能为空"></textarea>
				</div>
				
			</div>
			<div class="form-group">
				<label class="col-md-2 control-label">检查状态</label>
				<div class="col-md-4">
					<input class="form-control" id="status" readonly="readonly"  type="text" style="width:100%" name="status"/>
				</div>
			</div>
		</fieldset>
		<hr />
		
		<fieldset  id="person" style="display: none">
		<div class="form-group">
				<input class="form-control" type="hidden" name="id" id="id">
				<label class="col-md-2 control-label">协办人</label>
				<div class="col-md-4">
					<input class="easyui-combotree" readonly="readonly" placeholder="请选择协办人" width:"100%" type="text" name="assistPersonId" id="assistPersonId">
				</div>
				
				<label class="col-md-2 control-label">检查类型</label>
				<div class="col-md-4">				
					<input class="form-control " readonly="readonly"   type="text" id="checkMode" name="checkMode">	
				</div>
		</div>
			<div class="form-group">
				<label class="col-md-2 control-label ">检查时间</label>
				<div class="col-md-4">
					<input class="form-control " readonly="readonly"  placeholder="请输入检查时间" type="text" id="checkedDate" name="checkedDate">
				</div>
				<label class="col-md-2 control-label ">检查对象类型</label>
				<div class="col-md-4">
					<select class="form-control" readonly="readonly"   id="checkObjectType" name="checkObjectType"
						data-bv-notempty="true"
						data-bv-notempty-message="检查对象类型不能为空">
					</select>
				</div>
			</div>
			
			<div class="form-group">
				<label class="col-md-2 control-label gr gs">单位名称</label>
				<div class="col-md-4">
					<input class="form-control gr gs" readonly="readonly"  placeholder="请输入单位名称" type="text" name="unitName" id="unitName">
				</div>
				<label class="col-md-2 control-label gr">姓名</label>
				<div class="col-md-4">
					<input class="form-control gr"  readonly="readonly" placeholder="请输入姓名" type="text" name="checkedUserName" id="checkedUserName">
				</div>
				
			</div>
			
			<div class="form-group">
				<label class="col-md-2 control-label gs">注册号</label>
				<div class="col-md-4">
					<input class="form-control gs"  readonly="readonly" placeholder="请输入注册号" type="text" name="registNum" id="registNum">
				</div>
				<label class="col-md-2 control-label gs">法人</label>
				<div class="col-md-4">
					<input class="form-control gs" readonly="readonly"  placeholder="请输入法人" type="text" name="legalPerson" id="legalPerson">
				</div>
			</div>
			
			<div class="form-group">
				<label class="col-md-2 control-label gr gs">身份证号</label>
				<div class="col-md-4">
					<input class="form-control gr gs" readonly="readonly"  placeholder="请输入身份证号" type="text" name="checkedUserId" id="checkedUserId">
				</div>
				<label class="col-md-2 control-label gr gs">道路名称</label>
				<div class="col-md-4">
					<input class="form-control gr gs" readonly="readonly"  placeholder="请输入道路名称" type="text" name="roadName" id="roadName">
				</div>
			</div>
			
			<div class="form-group">
				<label class="col-md-2 control-label gr gs">巡查情况</label>
				<div class="col-md-10">
					<textarea class="form-control gr gs"  readonly="readonly" rows="" cols="" maxlength="480" name="checkSituation" id="checkSituation" placeholder="请输入巡查情况"
						data-bv-notempty="true"
						data-bv-notempty-message="巡查情况不能为空"></textarea>
				</div>
				
			</div>
		</fieldset>
		<hr />
		
		<fieldset>
			<div class="form-group">
				<label class="col-md-2 control-label" style="cursor:pointer" onclick="showHide('docDom',this)">文书列表<i class="fa fa-angle-double-up"></i></label>
				<div class="col-md-10" id="docDom">
					
				</div>
			</div>
		</fieldset>
		<hr />
		<fieldset>
			<div class="form-group">
				<label class="col-md-2 control-label" style="cursor:pointer" onclick="showHide('fileDom',this)">文件列表<i class="fa fa-angle-double-up"></i></label>
				<div class="col-md-10" id="fileDom">
					
				</div>
			</div>
		</fieldset>
		<hr />
		<fieldset>
			<div class="form-group">
				<label class="col-md-2 control-label" style="cursor:pointer" onclick="showHide('flowDom',this)">流程审批记录<i  class="fa fa-angle-double-up"></i></label>
				<div class="col-md-10" id="flowDom">
					
				</div>
			</div>
		</fieldset>
			
			<div class="form-actions">
				<div class="row" align="center">
					<div class="col-md-12">
						<button class="btn btn-primary" type="submit" onclick="backToList();">
							<i class="fa fa-save"></i> 返回
						</button>
					</div>
				</div>
			</div>
	</form>
</div>
	<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="../../js/jq.js"></script>
	<script type="text/javascript" src="../../js/plugin/bootstrapvalidator/bootstrapValidator.min.js"></script>
	<script type="text/javascript" src="../../js/common.js"></script>
	<script type="text/javascript" src="../../js/constans.js"></script>
	<script type="text/javascript" src="../../js/my/roles/role.js"></script>
	<script type="text/javascript" src="../../easyui/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../../layui/layui.js"></script>
	
<!-- 配置文件 -->
<script type="text/javascript" src="../../js/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="../../js/ueditor.all.min.js"></script>
<script src="../../js/moment-with-locales.min.js"></script>  
  
<script src="../../js/bootstrap-datetimepicker.min.js"></script>
<script src="../../js/select2/select2.full.min.js"></script>  
<script src="../../js/select2/zh-CN.js"></script>  
<script src="../../js/jquery-confirm/jquery-confirm.min.js"></script>  
    <script type="text/javascript">
    var checkNum = '';
    var deptId;
    var personId;
    
   // 初始默认隐藏部分内容
     $(".gs").hide();
     $(".gr").hide();
     $("#person").hide();
   		
   layui.use(['layer','laydate'], function(){
		    var layer = layui.layer;
		    var laydate = layui.laydate;
		    laydate.render({
	           elem: '#birthday'
	        });
		});
    //设置案源字典列表
    getDictList(dict.partyTtype,"checkObjectType");
    
    // 获取当前登录人的信息
        $.ajax({
			type : 'get',
			url : '/tts/sys/login',
			userdata : $("#form").serialize(),	
			success : function(userdata) {
				/**
				 * 树数据请求
				 */
				$("#assistPersonId").combotree({
					method:'get',		//请求方式
					url : '/tts/lssued/persons/'+userdata.dept_id,	//请求的URL
					required: false,
					onLoadSuccess:function(node,data){
					init();
					}
				});
			}
		});
		
    var id = getQuery('checkId');
    if ( id == null || id == '' ) {
    	alert('参数异常.');
    	window.location.href = 'checkDailyList.html';
    }
     function init(){
    	$.ajax({
			type : 'get',
			url : '/tts/case/deptPerson',
			success : function(data) {
				$.ajax({
					type : 'get',
					url : '/tts/lssued/query/' + id,
					contentType: "application/json; charset=utf-8",  
					async : false,
					success : function(data) {
					if ( data.code == '0') {							
						var checkInfo = data.data;
					
						$('#id').val(checkInfo.id);
						$('#checkNum').val(checkInfo.checkNum);
						checkNum=checkInfo.checkNum;
						$('#checkTitle').val(checkInfo.checkTitle);
						$('#checkObject').val(checkInfo.checkObject);
						$('#startDate').val(checkInfo.startDate);
						$('#endDate').val(checkInfo.endDate);
						$('#status').val(checkInfo.status);
						$('#checkBasis').val(checkInfo.checkBasis);
						$('#dept').val(checkInfo.deptName); 
						$('#personId').val(checkInfo.personName); 	
						$('#checkWay').val(checkInfo.checkWay);
						$('#checkContent').val(checkInfo.checkContent);

						if(checkInfo.recordId != null ){
							$("#person").show();
							if(checkInfo.checkObjectType == 2){
								$(".gs").show();
							}else if(checkInfo.checkObjectType == 1){
					       	 $(".gr").show();
						}
						$("#assistPersonId").combotree("setValue",checkInfo.assistPersonId);
						console.log(checkInfo.checkMode);
						$("#checkMode").val(checkInfo.checkMode);
						$("#checkObjectType").val(checkInfo.checkObjectType);
						$("#checkSituation").val(checkInfo.checkSituation);
						$("#checkedDate").val(checkInfo.checkedDate);
						$("#checkedUserId").val(checkInfo.checkedUserId);
						$("#checkedUserName").val(checkInfo.checkedUserName);
						$("#id").val(checkInfo.id);
						$("#legalPerson").val(checkInfo.legalPerson);
						$("#registNum").val(checkInfo.registNum);
						$("#roadName").val(checkInfo.roadName);
						$("#unitName").val(checkInfo.unitName);
					
						}else{
							$("#person").hide();
						}
						$('#checkedDate').datetimepicker({  
						    
					         format: 'YYYY-MM-DD HH:mm:ss',  
					         locale: moment.locale('zh-cn')  
					     });
						
					}
					if ( $('#status').val() != '检查暂存') {
						  $.ajax({
								type : 'get',
								url : '/tts/case/flow/comment/' + checkNum + '/' + 'proCheck',
								contentType: "application/json; charset=utf-8",  
								async : false,
								success : function(data) {
									if (data.code == '0') {
										var flowComments = data.data;
										var flowDomContent = '';
										if ( flowComments != null && flowComments.length > 0 ) {
											flowDomContent = '<table class="table"><tr><th>用户</th><th>任务名称</th><th>时间</th><th>批注</th></tr>';
											for ( var i = 0 ; i < flowComments.length ; i++) {
												flowDomContent += '<tr>';
												flowDomContent += '<td>' +flowComments[i].user+ '</td><td>'+flowComments[i].taskName+'</td><td>'+flowComments[i].time+'</td><td>'+flowComments[i].msg+'</td>';
												flowDomContent += '</tr>';
											}
											flowDomContent += '</table>';
										}
										$('#flowDom').html(flowDomContent);
									}
								}
							});
					  }
  
				}
			});
		}
	});	
}
 	
     
     
    
       $.ajax({
			type : 'get',
			url : '/tts/lssued/query/docContent/' + id,
			contentType: "application/json; charset=utf-8",  
			async : false,
			success : function(data) {
				if (data.code == '0') {
					var docs = data.data;
					var docDomContent = '';
					var hasDoc = "0";
					if ( docs != null && docs.length > 0 ) {
						hasDoc = "1";
						for ( var i = 0 ; i < docs.length ; i++) {
							if( !(docs[i].templateName == null)) {
								docDomContent = '<table class="table"><tr><th>案件状态</th><th>文书模板</th></tr>';
								for ( var i = 0 ; i < docs.length ; i++) {
		        					docDomContent += '<tr>';
									var href = 'docContentDetail.html?templateId='+docs[i].templateId+'&checkId='+id;
									docDomContent += '<td>'+docs[i].checkStatus+'</td><td><a href="javascript:;" onclick="window.open(\''+href+'\')">'+ docs[i].templateName +'</a></td>';
		        					docDomContent += '</tr>';
								}
								docDomContent += '</table>';
							}
						}
					}
					if ( hasDoc == "0" ) {
						$('#docDom').html('该案件还没添加任何文书');
					} else {
						$('#docDom').html(docDomContent);
					}
				}
			}
		});
       

	    function backToList() {
			var index = parent.layer.getFrameIndex(window.name);
			parent.layer.close(index);
	    }
	    
	    var toggleFlowFlag=0;
	    var toggleFileFlag=0;
	    var toggleDocFlag=0;
	    function showHide(id,dom){
	    	var $dom = $(dom);//转换成dom对象
	    	$("#"+id).toggle(1000);
	    	
	    	if(id=="flowDom"){
	    		if(!toggleFlowFlag){
	    			$dom.find("i").attr({class:"fa fa-angle-double-down"});
	    			toggleFlowFlag=1;
	    		}else{
	    			$dom.find("i").attr({class:"fa fa-angle-double-up"});
	    			toggleFlowFlag=0;
	    		}
	    	}else if(id=="fileDom"){
	    		if(!toggleFileFlag){
	    			$dom.find("i").attr({class:"fa fa-angle-double-down"});
	    			toggleFileFlag=1;
	    		}else{
	    			$dom.find("i").attr({class:"fa fa-angle-double-up"});
	    			toggleFileFlag=0;
	    		}
	    	}else if(id=="docDom"){
	    		if(!toggleDocFlag){
	    			$dom.find("i").attr({class:"fa fa-angle-double-down"});
	    			toggleDocFlag=1;
	    		}else{
	    			$dom.find("i").attr({class:"fa fa-angle-double-up"});
	    			toggleDocFlag=0;
	    		}
	    	}
	    }
	    
	    function showFile(id,fileType){
			layer.open({
				type: 2,
		        title: '在线预览',
		        shade: [0],
		        area: ['90%', '80%'],
		        shift: 2,
		        content: '../attachFile/fileShow.html?id=' + id + '&fileType=' + fileType,
		    });
		}
	    /**
	     * 获取案件的文件列表
	     */
	    $.ajax({
			type : 'get',
			url : "/tts/attachFile/caseFileList/"+id,
			contentType: "application/json; charset=utf-8",  
			async : false,
			success : function(data) {
				if (data.code == '0') {
					var fileComments = data.data;
					var fileDomContent = '';
					if ( fileComments != null && fileComments.length > 0 ) {
						fileDomContent = '<table class="table"><tr><th>文件名</th><th>文件类型</th><th>上传人</th><th>上传时间</th><th>操作</th></tr>';
						for ( var i = 0 ; i < fileComments.length ; i++) {
							var download = btnattachFileDownload("tts:attachFile:add", ["tts:attachFile:add"],fileComments[i].id);
        					var show = btnattachFileShow("tts:attachFile:add", ["tts:attachFile:add"],fileComments[i].id,fileComments[i].fileType);
							fileDomContent += '<tr>';
							fileDomContent += '<td>' +fileComments[i].fileName+ '</td><td>'+fileComments[i].fileType+'</td><td>'+fileComments[i].createName+'</td><td>'+fileComments[i].createDate+'</td><td>'+show+download+'</td>';
							fileDomContent += '</tr>';
						}
						fileDomContent += '</table>';
						$('#fileDom').html(fileDomContent);
					}else{
						$('#fileDom').html('该案件没有上传任何文件');
					}
					
				}else{
					$('#fileDom').html("查询文件信息失败！");
				}
			}
		});
	    
	    function downloadFile(id){
			var download = document.createElement("a");
			download.href='/tts/attachFile/download?id='+id;
			download.click();
		}
    </script>
</body>
</html>